CREATE TABLE `cart_items` (
   `id` int NOT NULL AUTO_INCREMENT,
   `userId` int NOT NULL,
   `comicId` int NOT NULL,
   `quantity` int DEFAULT '1',
   `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   `updatedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
   PRIMARY KEY (`id`),
   UNIQUE KEY `unique_user_item` (`userId`,`comicId`),
   KEY `comicId` (`comicId`),
   CONSTRAINT `cart_items_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
   CONSTRAINT `cart_items_ibfk_2` FOREIGN KEY (`comicId`) REFERENCES `comics` (`id`) ON DELETE CASCADE
 ) ENGINE=InnoDB AUTO_INCREMENT=49 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `chapters` (
   `id` int NOT NULL AUTO_INCREMENT,
   `comicId` int NOT NULL,
   `chapterNumber` decimal(6,2) NOT NULL,
   `title` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
   `contentUrls` json DEFAULT NULL,
   `price` int DEFAULT '0',
   `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   `updatedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
   `viewCount` int DEFAULT '0',
   PRIMARY KEY (`id`),
   UNIQUE KEY `idx_comic_chapter` (`comicId`,`chapterNumber`),
   CONSTRAINT `chapters_ibfk_1` FOREIGN KEY (`comicId`) REFERENCES `comics` (`id`) ON DELETE CASCADE
 ) ENGINE=InnoDB AUTO_INCREMENT=71 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE `chat_message_likes` (
   `messageId` int NOT NULL,
   `userId` int NOT NULL,
   PRIMARY KEY (`messageId`,`userId`),
   KEY `userId` (`userId`),
   CONSTRAINT `chat_message_likes_ibfk_1` FOREIGN KEY (`messageId`) REFERENCES `chat_messages` (`id`) ON DELETE CASCADE,
   CONSTRAINT `chat_message_likes_ibfk_2` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `chat_messages` (
   `id` int NOT NULL AUTO_INCREMENT,
   `userId` int NOT NULL,
   `comicId` int DEFAULT NULL,
   `chapterId` int DEFAULT NULL,
   `message` text,
   `imageUrl` varchar(255) DEFAULT NULL,
   `stickerUrl` varchar(255) DEFAULT NULL,
   `replyToMessageId` int DEFAULT NULL,
   `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   PRIMARY KEY (`id`),
   KEY `userId` (`userId`),
   KEY `comicId` (`comicId`),
   KEY `chapterId` (`chapterId`),
   KEY `replyToMessageId` (`replyToMessageId`),
   CONSTRAINT `chat_messages_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`),
   CONSTRAINT `chat_messages_ibfk_2` FOREIGN KEY (`comicId`) REFERENCES `comics` (`id`),
   CONSTRAINT `chat_messages_ibfk_3` FOREIGN KEY (`chapterId`) REFERENCES `chapters` (`id`),
   CONSTRAINT `chat_messages_ibfk_4` FOREIGN KEY (`replyToMessageId`) REFERENCES `chat_messages` (`id`) ON DELETE SET NULL
 ) ENGINE=InnoDB AUTO_INCREMENT=56 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `comic_genres` (
   `comicId` int NOT NULL,
   `genreId` int NOT NULL,
   PRIMARY KEY (`comicId`,`genreId`),
   KEY `genreId` (`genreId`),
   CONSTRAINT `comic_genres_ibfk_1` FOREIGN KEY (`comicId`) REFERENCES `comics` (`id`) ON DELETE CASCADE,
   CONSTRAINT `comic_genres_ibfk_2` FOREIGN KEY (`genreId`) REFERENCES `genres` (`id`) ON DELETE CASCADE
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `comics` (
   `id` int NOT NULL AUTO_INCREMENT,
   `title` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
   `author` varchar(150) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
   `description` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
   `coverImageUrl` varchar(1024) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT 'https://via.placeholder.com/200x300',
   `status` enum('Ongoing','Completed','Dropped') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT 'Ongoing',
   `isDigital` tinyint(1) DEFAULT '1',
   `price` decimal(10,2) DEFAULT '0.00',
   `viewCount` int DEFAULT '0',
   `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   `updatedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
   PRIMARY KEY (`id`),
   KEY `idx_title` (`title`),
   KEY `idx_author` (`author`),
   KEY `idx_status` (`status`)
 ) ENGINE=InnoDB AUTO_INCREMENT=36 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE `daily_comic_stats` (
   `id` int NOT NULL AUTO_INCREMENT,
   `comic_id` int NOT NULL,
   `view_date` date NOT NULL,
   `daily_view_count` int DEFAULT '0',
   PRIMARY KEY (`id`),
   UNIQUE KEY `idx_comic_date` (`comic_id`,`view_date`),
   CONSTRAINT `daily_comic_stats_ibfk_1` FOREIGN KEY (`comic_id`) REFERENCES `comics` (`id`) ON DELETE CASCADE
 ) ENGINE=InnoDB AUTO_INCREMENT=293 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `genres` (
   `id` int NOT NULL AUTO_INCREMENT,
   `name` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
   `description` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
   PRIMARY KEY (`id`),
   UNIQUE KEY `name` (`name`)
 ) ENGINE=InnoDB AUTO_INCREMENT=55 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;


CREATE TABLE `order_items` (
   `id` int NOT NULL AUTO_INCREMENT,
   `orderId` int NOT NULL,
   `comicId` int NOT NULL,
   `quantity` int NOT NULL,
   `price` decimal(15,2) NOT NULL,
   `title` varchar(255) DEFAULT NULL,
   `coverImageUrl` varchar(500) DEFAULT NULL,
   PRIMARY KEY (`id`),
   KEY `orderId` (`orderId`),
   KEY `comicId` (`comicId`),
   CONSTRAINT `order_items_ibfk_1` FOREIGN KEY (`orderId`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
   CONSTRAINT `order_items_ibfk_2` FOREIGN KEY (`comicId`) REFERENCES `comics` (`id`)
 ) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `orders` (
   `id` int NOT NULL AUTO_INCREMENT,
   `userId` int NOT NULL,
   `fullName` varchar(255) NOT NULL,
   `phone` varchar(20) NOT NULL,
   `address` text NOT NULL,
   `totalAmount` decimal(15,2) NOT NULL,
   `paymentMethod` varchar(20) NOT NULL,
   `status` varchar(50) DEFAULT 'PENDING',
   `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   PRIMARY KEY (`id`),
   KEY `userId` (`userId`),
   CONSTRAINT `orders_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
 ) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `payment_transactions` (
   `id` int NOT NULL AUTO_INCREMENT,
   `userId` int NOT NULL,
   `orderId` varchar(50) NOT NULL,
   `amount` decimal(15,2) NOT NULL,
   `status` varchar(20) NOT NULL,
   `type` varchar(20) NOT NULL,
   `description` text,
   `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   PRIMARY KEY (`id`),
   KEY `userId` (`userId`),
   CONSTRAINT `payment_transactions_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
 ) ENGINE=InnoDB AUTO_INCREMENT=19 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `reviews` (
   `id` int NOT NULL AUTO_INCREMENT,
   `userId` int NOT NULL,
   `comicId` int NOT NULL,
   `rating` int DEFAULT NULL,
   `comment` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
   `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   `updatedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
   PRIMARY KEY (`id`),
   UNIQUE KEY `idx_user_comic_review` (`userId`,`comicId`),
   KEY `comicId` (`comicId`),
   CONSTRAINT `reviews_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
   CONSTRAINT `reviews_ibfk_2` FOREIGN KEY (`comicId`) REFERENCES `comics` (`id`) ON DELETE CASCADE,
   CONSTRAINT `reviews_chk_1` CHECK (((`rating` >= 1) and (`rating` <= 5)))
 ) ENGINE=InnoDB AUTO_INCREMENT=17 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE `user_bookmarks` (
   `userId` int NOT NULL,
   `comicId` int NOT NULL,
   `lastReadChapterId` int DEFAULT NULL,
   `updatedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
   PRIMARY KEY (`userId`,`comicId`),
   KEY `comicId` (`comicId`),
   KEY `lastReadChapterId` (`lastReadChapterId`),
   CONSTRAINT `user_bookmarks_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
   CONSTRAINT `user_bookmarks_ibfk_2` FOREIGN KEY (`comicId`) REFERENCES `comics` (`id`) ON DELETE CASCADE,
   CONSTRAINT `user_bookmarks_ibfk_3` FOREIGN KEY (`lastReadChapterId`) REFERENCES `chapters` (`id`) ON DELETE SET NULL
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE `user_library` (
   `userId` int NOT NULL,
   `comicId` int NOT NULL,
   `purchasedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   PRIMARY KEY (`userId`,`comicId`),
   KEY `comicId` (`comicId`),
   CONSTRAINT `user_library_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
   CONSTRAINT `user_library_ibfk_2` FOREIGN KEY (`comicId`) REFERENCES `comics` (`id`) ON DELETE CASCADE
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE `user_unlocked_chapters` (
   `userId` int NOT NULL,
   `chapterId` int NOT NULL,
   `unlockedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   PRIMARY KEY (`userId`,`chapterId`),
   KEY `chapterId_idx` (`chapterId`),
   CONSTRAINT `fk_user_unlocked_chapter` FOREIGN KEY (`chapterId`) REFERENCES `chapters` (`id`) ON DELETE CASCADE,
   CONSTRAINT `fk_user_unlocked_user` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `user_wishlist` (
   `userId` int NOT NULL,
   `comicId` int NOT NULL,
   `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   PRIMARY KEY (`userId`,`comicId`),
   KEY `comicId` (`comicId`),
   CONSTRAINT `user_wishlist_ibfk_1` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
   CONSTRAINT `user_wishlist_ibfk_2` FOREIGN KEY (`comicId`) REFERENCES `comics` (`id`) ON DELETE CASCADE
 ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `users` (
   `id` int NOT NULL AUTO_INCREMENT,
   `email` varchar(255) NOT NULL,
   `password` varchar(255) NOT NULL,
   `fullName` varchar(255) DEFAULT NULL,
   `phone` varchar(20) DEFAULT NULL,
   `coinBalance` int DEFAULT '1000',
   `lastDailyLogin` timestamp NULL DEFAULT '2000-01-01 00:00:00',
   `consecutiveLoginDays` int DEFAULT '0',
   `level` int DEFAULT '1',
   `exp` decimal(20,2) DEFAULT '0.00',
   `addresses` json DEFAULT NULL,
   `avatarUrl` varchar(1024) DEFAULT 'https://via.placeholder.com/150',
   `isBanned` tinyint(1) NOT NULL DEFAULT '0',
   `resetPasswordToken` varchar(255) DEFAULT NULL,
   `resetPasswordExpires` datetime DEFAULT NULL,
   `acc_created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
   PRIMARY KEY (`id`),
   UNIQUE KEY `email` (`email`)
 ) ENGINE=InnoDB AUTO_INCREMENT=10000006 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- Tạo bảng gói nạp
CREATE TABLE `recharge_packs` (
  `id` int NOT NULL AUTO_INCREMENT,
  `coins` int NOT NULL,
  `price` decimal(15,2) NOT NULL,
  `bonus` int DEFAULT '0',
  `name` varchar(255) DEFAULT NULL COMMENT 'Tên gói (nếu có)',
  `isActive` tinyint(1) DEFAULT '1',
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tạo bảng voucher
CREATE TABLE `vouchers` (
  `id` int NOT NULL AUTO_INCREMENT,
  `code` varchar(50) NOT NULL,
  `discountType` enum('PERCENT','FIXED') NOT NULL DEFAULT 'PERCENT',
  `discountValue` decimal(15,2) NOT NULL,
  `minOrderValue` decimal(15,2) DEFAULT '0.00',
  `maxDiscountAmount` decimal(15,2) DEFAULT NULL,
  `startDate` datetime DEFAULT NULL,
  `endDate` datetime DEFAULT NULL,
  `usageLimit` int DEFAULT NULL,
  `usedCount` int DEFAULT '0',
  `isActive` tinyint(1) DEFAULT '1',
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

ALTER TABLE comics ADD COLUMN soldCount INT DEFAULT 0;
ALTER TABLE `payment_transactions` 
ADD COLUMN `transactionCode` VARCHAR(50) DEFAULT NULL AFTER `orderId`,
ADD UNIQUE KEY `idx_transaction_code` (`transactionCode`);

-- Tạo bảng bài viết
CREATE TABLE IF NOT EXISTS `posts` (
  `id` int NOT NULL AUTO_INCREMENT,
  `userId` int NOT NULL,
  `content` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `imageUrl` varchar(255) DEFAULT NULL,
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updatedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tạo bảng Like
CREATE TABLE IF NOT EXISTS `post_likes` (
  `id` int NOT NULL AUTO_INCREMENT,
  `postId` int NOT NULL,
  `userId` int NOT NULL,
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_like` (`postId`, `userId`),
  FOREIGN KEY (`postId`) REFERENCES `posts` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tạo bảng Bình luận
CREATE TABLE IF NOT EXISTS `comments` (
  `id` int NOT NULL AUTO_INCREMENT,
  `postId` int NOT NULL,
  `userId` int NOT NULL,
  `content` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `imageUrl` varchar(255) DEFAULT NULL,
  `stickerUrl` varchar(255) DEFAULT NULL,
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  FOREIGN KEY (`postId`) REFERENCES `posts` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 1. Thêm cột parentId vào bảng comments để biết bình luận này trả lời ai
ALTER TABLE `comments` 
ADD COLUMN `parentId` int DEFAULT NULL AFTER `userId`,
ADD CONSTRAINT `fk_comment_parent` FOREIGN KEY (`parentId`) REFERENCES `comments` (`id`) ON DELETE CASCADE;

-- 2. Tạo bảng Like cho Comment
CREATE TABLE IF NOT EXISTS `comment_likes` (
  `id` int NOT NULL AUTO_INCREMENT,
  `commentId` int NOT NULL,
  `userId` int NOT NULL,
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_comment_like` (`commentId`, `userId`),
  FOREIGN KEY (`commentId`) REFERENCES `comments` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `reports` (
  `id` int NOT NULL AUTO_INCREMENT,
  `reporterId` int NOT NULL,
  `targetId` int NOT NULL, -- ID của bài viết hoặc bình luận bị báo cáo
  `targetType` enum('POST', 'COMMENT') NOT NULL, -- Phân biệt báo cáo bài hay báo cáo cmt
  `reason` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `status` enum('PENDING', 'RESOLVED', 'REJECTED') DEFAULT 'PENDING',
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  FOREIGN KEY (`reporterId`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

ALTER TABLE `reports`
ADD COLUMN `snapshotContent` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci AFTER `reason`,
ADD COLUMN `snapshotImage` varchar(255) DEFAULT NULL AFTER `snapshotContent`;

CREATE TABLE IF NOT EXISTS `notifications` (
  `id` int NOT NULL AUTO_INCREMENT,
  `userId` int NOT NULL,
  `type` enum('SYSTEM', 'ORDER', 'COMIC', 'COMMUNITY', 'RECHARGE') NOT NULL DEFAULT 'SYSTEM',
  `title` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `message` text COLLATE utf8mb4_unicode_ci NOT NULL,
  `referenceId` int DEFAULT NULL, -- ID của đơn hàng, truyện, hoặc bài viết liên quan
  `referenceType` varchar(50) DEFAULT NULL, -- 'ORDER', 'COMIC', 'POST', 'COMMENT'
  `isRead` tinyint(1) DEFAULT '0',
  `imageUrl` varchar(255) DEFAULT NULL, -- Avatar người tương tác hoặc ảnh bìa truyện
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_read` (`userId`, `isRead`),
  FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Bảng lưu trữ đợt Flash Sale
CREATE TABLE `flash_sales` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `startTime` datetime NOT NULL,
  `endTime` datetime NOT NULL,
  `status` enum('PENDING','ACTIVE','ENDED') DEFAULT 'PENDING',
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Bảng lưu trữ sản phẩm trong Flash Sale
CREATE TABLE `flash_sale_items` (
  `id` int NOT NULL AUTO_INCREMENT,
  `flashSaleId` int NOT NULL,
  `comicId` int NOT NULL,
  `salePrice` int NOT NULL, -- Giá ưu đãi
  `quantityLimit` int NOT NULL DEFAULT 10, -- Giới hạn số lượng bán ra
  `soldQuantity` int NOT NULL DEFAULT 0, -- Số lượng đã bán
  PRIMARY KEY (`id`),
  FOREIGN KEY (`flashSaleId`) REFERENCES `flash_sales` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`comicId`) REFERENCES `comics` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

ALTER TABLE users ADD COLUMN levelSystem VARCHAR(50) DEFAULT 'default';
ALTER TABLE users ADD COLUMN pendingAvatarUrl VARCHAR(1024) DEFAULT NULL;

-- 1. Bảng lưu lịch sử quay thưởng (để tra soát và thống kê)
CREATE TABLE `event_christmas_history` (
  `id` int NOT NULL AUTO_INCREMENT,
  `userId` int NOT NULL,
  `rewardType` enum('coin','voucher','physical_comic','luck') NOT NULL, -- Loại phần thưởng
  `rewardValue` varchar(255) DEFAULT NULL, -- Giá trị (VD: 50, 'GIAM20', 'Conan Tap 1')
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_event` (`userId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. Bảng lưu lời chúc Cây thông
CREATE TABLE `event_christmas_wishes` (
  `id` int NOT NULL AUTO_INCREMENT,
  `userId` int NOT NULL,
  `content` varchar(200) NOT NULL,
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Thêm cột lượt quay và thời gian chúc
ALTER TABLE `users` 
ADD COLUMN `spins` INT DEFAULT 0,
ADD COLUMN `lastWishDate` DATE DEFAULT NULL;

-- Tạo bảng lưu tiến độ nhiệm vụ (nếu muốn làm kỹ nhiệm vụ đọc/mua)
CREATE TABLE IF NOT EXISTS `user_missions` (
  `userId` int NOT NULL,
  `missionType` varchar(50) NOT NULL, -- 'LOGIN', 'BUY_COMIC', 'READ_CHAPTER'
  `progress` int DEFAULT 0,
  `target` int DEFAULT 1,
  `isClaimed` tinyint(1) DEFAULT 0,
  `updatedAt` date NOT NULL, -- Reset mỗi ngày
  PRIMARY KEY (`userId`, `missionType`, `updatedAt`)
);

CREATE TABLE IF NOT EXISTS `user_event_status` (
  `userId` int NOT NULL,
  `spins` int DEFAULT 0,
  `lastWishDate` date DEFAULT NULL,
  PRIMARY KEY (`userId`),
  CONSTRAINT `fk_event_status_user` FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. (Tùy chọn) Chuyển dữ liệu cũ sang bảng mới nếu muốn giữ lại
INSERT IGNORE INTO `user_event_status` (userId, spins, lastWishDate)
SELECT id, IFNULL(spins, 0), lastWishDate FROM `users`;

-- 3. Xóa các cột sự kiện ở bảng users cho sạch sẽ
ALTER TABLE `users` 
DROP COLUMN `spins`,
DROP COLUMN `lastWishDate`;

ALTER TABLE `reports` MODIFY COLUMN `targetType` ENUM('POST', 'COMMENT', 'CHAT_MESSAGE') NOT NULL;

CREATE TABLE IF NOT EXISTS `giftcodes` (
  `id` int NOT NULL AUTO_INCREMENT,
  `code` varchar(50) NOT NULL UNIQUE,
  `coinReward` int DEFAULT 0,
  `expReward` int DEFAULT 0,
  `voucherId` int DEFAULT NULL,
  `usageLimit` int DEFAULT 1,
  `usedCount` int DEFAULT 0,
  `expiryDate` datetime DEFAULT NULL,
  `isActive` tinyint(1) DEFAULT 1,
  `createdAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `user_giftcode_usage` (
  `id` int NOT NULL AUTO_INCREMENT,
  `userId` int NOT NULL,
  `giftcodeId` int NOT NULL,
  `claimedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_user_code` (`userId`, `giftcodeId`),
  FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`giftcodeId`) REFERENCES `giftcodes` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `user_voucher_usage` (
  `id` int NOT NULL AUTO_INCREMENT,
  `userId` int NOT NULL,
  `voucherId` int NOT NULL,
  `usedAt` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_user_voucher` (`userId`, `voucherId`),
  FOREIGN KEY (`userId`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`voucherId`) REFERENCES `vouchers` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

ALTER TABLE `reviews`
ADD COLUMN `images` JSON NULL DEFAULT NULL COMMENT 'Lưu mảng URL ảnh',
ADD COLUMN `video` VARCHAR(255) NULL DEFAULT NULL COMMENT 'Lưu URL video';

ALTER TABLE `users`
ADD COLUMN `otpCode` VARCHAR(10) NULL DEFAULT NULL,
ADD COLUMN `otpExpires` DATETIME NULL DEFAULT NULL;

ALTER TABLE `users`
ADD COLUMN `role` ENUM('user', 'admin') DEFAULT 'user' AFTER `email`;